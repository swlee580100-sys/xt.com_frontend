generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 管理员表 - 独立的管理后台用户
model Admin {
  id               String    @id @default(uuid())
  username         String    @unique
  email            String    @unique
  displayName      String
  passwordHash     String
  refreshTokenHash String?
  permissions      Json?     // 权限列表，如 ["users:manage", "system:config"]
  isActive         Boolean   @default(true)
  lastLoginAt      DateTime?
  lastLoginIp      String?   // 最后登录IP地址
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([email])
  @@index([username])
}

// 客户用户表 - 使用平台进行交易的用户
model User {
  id                 String             @id @default(uuid())
  email              String             @unique
  displayName        String
  passwordHash       String
  refreshTokenHash   String?
  roles              Json?
  isActive           Boolean            @default(true)
  lastLoginAt        DateTime?
  lastLoginIp        String?            // 最后登录IP地址
  avatar             String?            // 用户头像 URL
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  accountBalance     Decimal            @default(10000) @db.Decimal(18, 8)
  totalProfitLoss    Decimal            @default(0) @db.Decimal(18, 8)
  totalTrades        Int                @default(0)
  verificationStatus VerificationStatus @default(PENDING)
  winRate            Decimal            @default(0) @db.Decimal(5, 2)
  demoBalance        Decimal            @default(10000) @db.Decimal(18, 8)
  phoneNumber        String             @unique
  realBalance        Decimal            @default(0) @db.Decimal(18, 8)
  orders             Order[]
  sessions           Session[]
  transactionLogs    TransactionLog[]

  @@index([email])
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  ip        String?
  userAgent String?
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Order {
  id             String      @id @default(uuid())
  userId         String
  symbol         String
  side           OrderSide
  type           OrderType
  status         OrderStatus @default(PENDING)
  price          Decimal?    @db.Decimal(18, 8)
  quantity       Decimal     @db.Decimal(18, 8)
  filledQuantity Decimal     @default(0) @db.Decimal(18, 8)
  metadata       Json?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  user           User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  trades         Trade[]

  @@index([userId, symbol])
}

model Trade {
  id        String   @id @default(uuid())
  orderId   String
  symbol    String
  price     Decimal  @db.Decimal(18, 8)
  quantity  Decimal  @db.Decimal(18, 8)
  fee       Decimal  @default(0) @db.Decimal(18, 8)
  isMaker   Boolean  @default(false)
  createdAt DateTime @default(now())
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([symbol, createdAt])
}

model MarketSnapshot {
  id        String   @id @default(uuid())
  symbol    String
  price     Decimal  @db.Decimal(18, 8)
  change24h Decimal  @db.Decimal(7, 2)
  raw       Json?
  source    String
  createdAt DateTime @default(now())

  @@index([symbol, createdAt])
}

model TransactionLog {
  id           String            @id @default(uuid())
  userId       String
  userName     String?           // 用户名（冗余字段，方便查询）
  orderNumber  String            @unique
  assetType    String
  direction    TradeDirection
  entryTime    DateTime
  expiryTime   DateTime
  duration     Int
  entryPrice   Decimal           @db.Decimal(18, 8)
  currentPrice Decimal?          @db.Decimal(18, 8)
  exitPrice    Decimal?          @db.Decimal(18, 8)
  spread       Decimal           @db.Decimal(18, 8)
  investAmount Decimal           @db.Decimal(18, 8)
  returnRate   Decimal           @db.Decimal(7, 4)
  actualReturn Decimal           @db.Decimal(18, 8)
  status       TransactionStatus @default(PENDING)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  settledAt    DateTime?
  accountType  AccountType       @default(DEMO)
  isManaged    Boolean           @default(false) // 是否在托管状态下产生的交易
  user         User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([userId, accountType])
  @@index([orderNumber])
  @@index([assetType, createdAt])
  @@index([entryTime, expiryTime])
}

model Testimonial {
  id        String   @id @default(uuid())
  name      String
  title     String
  rating    Int
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([createdAt])
}

model CarouselItem {
  id        String   @id @default(uuid())
  sortOrder Int
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sortOrder])
}

model LeaderboardEntry {
  id         String           @id @default(uuid())
  type       LeaderboardType
  avatar     String?
  country    String
  name       String
  tradeCount Int
  winRate    Decimal          @db.Decimal(5, 2)
  volume     Decimal          @db.Decimal(18, 2)
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  @@index([type, tradeCount])
}

model TradingPerformance {
  id            String   @id @default(uuid())
  tradeDuration Int
  winRate       Decimal  @db.Decimal(5, 2)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([tradeDuration])
}

enum OrderSide {
  BUY
  SELL
}

enum OrderType {
  MARKET
  LIMIT
  STOP
}

enum OrderStatus {
  PENDING
  PARTIALLY_FILLED
  FILLED
  CANCELED
  REJECTED
}

enum VerificationStatus {
  PENDING        // 待审核
  IN_REVIEW      // 审核中
  VERIFIED       // 验证成功
  REJECTED       // 验证失败
}

enum TradeDirection {
  CALL
  PUT
}

enum TransactionStatus {
  PENDING
  SETTLED
  CANCELED
}

enum AccountType {
  DEMO
  REAL
}

enum LeaderboardType {
  DAILY
  WEEKLY
  MONTHLY
}

// 系统设置表
model SystemSettings {
  id          String   @id @default(uuid())
  key         String   @unique // 设置键，如 "admin.username", "trading.channels", etc.
  value       Json     // 设置值（JSON 格式）
  category    String   // 分类：admin, trading, customer_service, latency, etc.
  description String?  // 描述
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@index([key])
}
