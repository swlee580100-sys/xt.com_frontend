generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String             @id @default(uuid())
  email              String             @unique
  displayName        String
  passwordHash       String
  refreshTokenHash   String?
  roles              Json?
  isActive           Boolean            @default(true)
  lastLoginAt        DateTime?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  accountBalance     Decimal            @default(10000) @db.Decimal(18, 8)
  totalProfitLoss    Decimal            @default(0) @db.Decimal(18, 8)
  totalTrades        Int                @default(0)
  verificationStatus VerificationStatus @default(UNVERIFIED)
  winRate            Decimal            @default(0) @db.Decimal(5, 2)
  demoBalance        Decimal            @default(10000) @db.Decimal(18, 8)
  phoneNumber        String             @unique
  realBalance        Decimal            @default(0) @db.Decimal(18, 8)
  orders             Order[]
  sessions           Session[]
  transactionLogs    TransactionLog[]

  @@index([email])
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  ip        String?
  userAgent String?
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Order {
  id             String      @id @default(uuid())
  userId         String
  symbol         String
  side           OrderSide
  type           OrderType
  status         OrderStatus @default(PENDING)
  price          Decimal?    @db.Decimal(18, 8)
  quantity       Decimal     @db.Decimal(18, 8)
  filledQuantity Decimal     @default(0) @db.Decimal(18, 8)
  metadata       Json?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  user           User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  trades         Trade[]

  @@index([userId, symbol])
}

model Trade {
  id        String   @id @default(uuid())
  orderId   String
  symbol    String
  price     Decimal  @db.Decimal(18, 8)
  quantity  Decimal  @db.Decimal(18, 8)
  fee       Decimal  @default(0) @db.Decimal(18, 8)
  isMaker   Boolean  @default(false)
  createdAt DateTime @default(now())
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([symbol, createdAt])
}

model MarketSnapshot {
  id        String   @id @default(uuid())
  symbol    String
  price     Decimal  @db.Decimal(18, 8)
  change24h Decimal  @db.Decimal(7, 2)
  raw       Json?
  source    String
  createdAt DateTime @default(now())

  @@index([symbol, createdAt])
}

model TransactionLog {
  id           String            @id @default(uuid())
  userId       String
  orderNumber  String            @unique
  assetType    String
  direction    TradeDirection
  entryTime    DateTime
  expiryTime   DateTime
  duration     Int
  entryPrice   Decimal           @db.Decimal(18, 8)
  currentPrice Decimal?          @db.Decimal(18, 8)
  exitPrice    Decimal?          @db.Decimal(18, 8)
  spread       Decimal           @db.Decimal(18, 8)
  investAmount Decimal           @db.Decimal(18, 8)
  returnRate   Decimal           @db.Decimal(7, 4)
  actualReturn Decimal           @db.Decimal(18, 8)
  status       TransactionStatus @default(PENDING)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  settledAt    DateTime?
  accountType  AccountType       @default(DEMO)
  user         User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([userId, accountType])
  @@index([orderNumber])
  @@index([assetType, createdAt])
  @@index([entryTime, expiryTime])
}

enum OrderSide {
  BUY
  SELL
}

enum OrderType {
  MARKET
  LIMIT
  STOP
}

enum OrderStatus {
  PENDING
  PARTIALLY_FILLED
  FILLED
  CANCELED
  REJECTED
}

enum VerificationStatus {
  UNVERIFIED
  VERIFIED
}

enum TradeDirection {
  CALL
  PUT
}

enum TransactionStatus {
  PENDING
  SETTLED
  CANCELED
}

enum AccountType {
  DEMO
  REAL
}
